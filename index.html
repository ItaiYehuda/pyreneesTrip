<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Explorer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Added external CSS for cleaner design -->
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <!-- Navigation bar -->
  <nav>
    <button onclick="openTab('hikes')">Hikes</button>
    <button onclick="openTab('accommodations')">Accommodations</button>
    <button onclick="openTab('attractions')">Attractions</button>
    <button onclick="openTab('map')">Map</button>
  </nav>

  <!-- Search bar below nav -->
  <div id="searchBarContainer">
    <input id="globalSearch" type="search" placeholder="Search visible tableâ€¦" aria-label="Search"/>
    <small>Tip: filters the currently open tab.</small>
  </div>

  <!-- Content sections -->
  <div id="hikes" class="tab"></div>
  <div id="accommodations" class="tab"></div>
  <div id="attractions" class="tab"></div>
  <div id="map" class="tab">
    <div id="mapContainer"></div>
  </div>

  <script>
    // Tab switching
    function openTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      if(tabId === 'map') { map.invalidateSize(); }
    }

    // Load CSV data into tables and map markers
    function loadCSV(file, containerId, icon, isHikes=false) {
      Papa.parse(file, {
        header: true,
        download: true,
        complete: function(results) {
          const data = results.data.filter(row => row.Name);
          if(containerId !== 'map') {
            const container = document.getElementById(containerId);
            let table = '<table><tr>';
            Object.keys(data[0]).forEach(k => {
              if(k !== 'Latitude' && k !== 'Longitude') {
                table += '<th>' + k + '</th>';
              }
            });
            table += '</tr>';
            data.forEach(row => {
              table += '<tr>';
              Object.entries(row).forEach(([k,v]) => {
                if(k !== 'Latitude' && k !== 'Longitude') {
                  if(isHikes && k === 'Name') {
                    const q = encodeURIComponent(v);
                    table += '<td><a class="hike-link" href="https://www.google.com/search?q=' + q + '" target="_blank">' + v + '</a></td>';
                  } else {
                    table += '<td>' + v + '</td>';
                  }
                }
              });
              table += '</tr>';
            });
            table += '</table>';
            container.innerHTML = table;
          } else {
            data.forEach(row => {
              if(row.Latitude && row.Longitude) {
                const lat = parseFloat(row.Latitude);
                const lon = parseFloat(row.Longitude);
                if(!isNaN(lat) && !isNaN(lon)) {
                  const marker = L.marker([lat, lon], { icon: icon }).addTo(map);
                  let popupContent = '<div class="popup-content">';
                  popupContent += '<div class="popup-title">' + row.Name + '</div>';
                  for(const [k,v] of Object.entries(row)) {
                    if(k !== 'Latitude' && k !== 'Longitude' && v) {
                      popupContent += '<div class="popup-info"><b>' + k + ':</b> ' + v + '</div>';
                    }
                  }
                  const q = encodeURIComponent(row.Name);
                  popupContent += '<a class="popup-link" href="https://www.google.com/search?q=' + q + '" target="_blank">ðŸ”Ž Search on Google</a>';
                  popupContent += '</div>';
                  marker.bindPopup(popupContent);
                }
              }
            });
          }
        }
      });
    }

    // Leaflet custom colored markers
    function coloredIcon(color) {
      return new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + color + '.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    var blueIcon = coloredIcon('blue');
    var greenIcon = coloredIcon('green');
    var redIcon = coloredIcon('red');

    // Initialize map
    var map = L.map('mapContainer').setView([42.5, 1.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // Load datasets
    loadCSV('data/hikes.csv', 'hikes', blueIcon, true);
    loadCSV('data/accommodations.csv', 'accommodations', greenIcon);
    loadCSV('data/attractions.csv', 'attractions', redIcon);
    loadCSV('data/hikes.csv', 'map', blueIcon, true);
    loadCSV('data/accommodations.csv', 'map', greenIcon);
    loadCSV('data/attractions.csv', 'map', redIcon);

    // Default open tab = MAP
    openTab('map');
  </script>

  <!-- Lightweight search script -->
  <script>
    (function(){
      function filterVisibleTable(q){
        var tabs = document.querySelectorAll('.tab');
        var active = Array.prototype.find.call(tabs, function(t){ return t.style.display !== 'none'; });
        if(!active) return;
        var table = active.querySelector('table');
        if(!table) return;
        var rows = table.querySelectorAll('tbody tr, tr');
        var qnorm = (q||'').trim().toLowerCase();
        Array.prototype.forEach.call(rows, function(row){
          var isHeader = row.querySelector('th') !== null;
          if(isHeader) return;
          var text = row.textContent.toLowerCase();
          row.style.display = text.includes(qnorm) ? '' : 'none';
        });
      }
      var input = document.getElementById('globalSearch');
      if(input){
        input.addEventListener('input', function(e){
          filterVisibleTable(e.target.value);
        });
        var originalOpenTab = window.openTab;
        window.openTab = function(tabId){
          if(typeof originalOpenTab === 'function') originalOpenTab(tabId);
          setTimeout(function(){ filterVisibleTable(input.value); }, 0);
        };
      }
    })();
  </script>
</body>
</html>
