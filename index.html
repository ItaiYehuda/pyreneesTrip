<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Explorer</title>
<link href="https://unpkg.com/leaflet/dist/leaflet.css" rel="stylesheet"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    nav { background: #111; display: flex; justify-content: center; }
    nav button { background: #111; color: white; border: none; padding: 12px 20px; cursor: pointer; font-size: 16px; }
    nav button.active { background: #333; }
    nav button:hover { background: #555; }
    .tab { display: none; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #333; color: white; }
    tr:nth-child(even) { background: #f2f2f2; }
    a.hike-link { color: #0066cc; text-decoration: none; font-weight: bold; }
    a.hike-link:hover { text-decoration: underline; }
    #mapContainer { height: 80vh; width: 100%; border: 2px solid #111; margin-top: 10px; }
    .popup-content { font-size: 14px; line-height: 1.4; }
    .popup-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #222; }
    .popup-info { margin-bottom: 5px; }
    .popup-link { display: inline-block; margin-top: 5px; padding: 4px 8px; background: #111; color: white; text-decoration: none; border-radius: 4px; font-size: 13px; }
    .popup-link:hover { background: #444; }
  </style>
<link href="styles.css" rel="stylesheet"/></head>
<body>
<nav>
<button onclick="openTab('hikes')">Hikes</button>
<button onclick="openTab('accommodations')">Accommodations</button>
<button onclick="openTab('attractions')">Attractions</button>
<button onclick="openTab('map')">Map</button>
</nav><div id="searchBarContainer"><input aria-label="Search" id="globalSearch" placeholder="Search visible tableâ€¦" type="search"/><small>Tip: filters the currently open tab.</small></div>
<div class="tab" id="hikes"></div>
<div class="tab" id="accommodations"></div>
<div class="tab" id="attractions"></div>
<div class="tab" id="map"><div id="mapContainer"></div></div>
<script>
    function openTab(tabId) {
      document.querySelectorAll('.tab').forEach(t => t.style.display = 'none');
      document.getElementById(tabId).style.display = 'block';
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      if(tabId === 'map') { map.invalidateSize(); }
    }

    function loadCSV(file, containerId, icon, isHikes=false) {
      Papa.parse(file, {
        header: true,
        download: true,
        complete: function(results) {
          const data = results.data.filter(row => row.Name);
          if(containerId !== 'map') {
            const container = document.getElementById(containerId);
            let table = '<table><tr>';
            Object.keys(data[0]).forEach(k => {
              if(k !== 'Latitude' && k !== 'Longitude') {
                table += '<th>' + k + '</th>';
              }
            });
            table += '</tr>';
            data.forEach(row => {
              table += '<tr>';
              Object.entries(row).forEach(([k,v]) => {
                if(k !== 'Latitude' && k !== 'Longitude') {
                  if(isHikes && k === 'Name') {
                    const q = encodeURIComponent(v);
                    table += '<td><a class="hike-link" href="https://www.google.com/search?q=' + q + '" target="_blank">' + v + '</a></td>';
                  } else {
                    table += '<td>' + v + '</td>';
                  }
                }
              });
              table += '</tr>';
            });
            table += '</table>';
            container.innerHTML = table;
          } else {
            data.forEach(row => {
              if(row.Latitude && row.Longitude) {
                const lat = parseFloat(row.Latitude);
                const lon = parseFloat(row.Longitude);
                if(!isNaN(lat) && !isNaN(lon)) {
                  const marker = L.marker([lat, lon], { icon: icon }).addTo(map);
                  let popupContent = '<div class="popup-content">';
                  popupContent += '<div class="popup-title">' + row.Name + '</div>';
                  for(const [k,v] of Object.entries(row)) {
                    if(k !== 'Latitude' && k !== 'Longitude' && v) {
                      popupContent += '<div class="popup-info"><b>' + k + ':</b> ' + v + '</div>';
                    }
                  }
                  const q = encodeURIComponent(row.Name);
                  popupContent += '<a class="popup-link" href="https://www.google.com/search?q=' + q + '" target="_blank">ðŸ”Ž Search on Google</a>';
                  popupContent += '</div>';
                  marker.bindPopup(popupContent);
                }
              }
            });
          }
        }
      });
    }

    // Custom icons (Leaflet pin colors)
    function coloredIcon(color) {
      return new L.Icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-' + color + '.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    var blueIcon = coloredIcon('blue');
    var greenIcon = coloredIcon('green');
    var redIcon = coloredIcon('red');

    // Leaflet map
    var map = L.map('mapContainer').setView([42.5, 1.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // Load data with icons
    loadCSV('data/hikes.csv', 'hikes', blueIcon, true);
    loadCSV('data/accommodations.csv', 'accommodations', greenIcon);
    loadCSV('data/attractions.csv', 'attractions', redIcon);
    loadCSV('data/hikes.csv', 'map', blueIcon, true);
    loadCSV('data/accommodations.csv', 'map', greenIcon);
    loadCSV('data/attractions.csv', 'map', redIcon);

    // Default open
    openTab('hikes');
  </script>
<script>
// Lightweight search that filters the currently visible tab's table rows.
// Does not modify existing code; safe no-op if no table is present.
(function(){
  function filterVisibleTable(q){
    var tabs = document.querySelectorAll('.tab');
    var active = Array.prototype.find.call(tabs, function(t){ return t.style.display !== 'none'; });
    if(!active) return;
    var table = active.querySelector('table');
    if(!table) return;
    var rows = table.querySelectorAll('tbody tr, tr'); // support tables with/without <tbody>
    var qnorm = (q||'').trim().toLowerCase();
    Array.prototype.forEach.call(rows, function(row, idx){
      // skip header row
      var isHeader = row.querySelector('th') !== null;
      if(isHeader) return;
      var text = row.textContent.toLowerCase();
      var match = text.indexOf(qnorm) !== -1;
      row.style.display = match ? '' : 'none';
    });
  }
  var input = document.getElementById('globalSearch');
  if(input){
    input.addEventListener('input', function(e){
      filterVisibleTable(e.target.value);
    });
    // Re-apply filter whenever tabs switch (monkey-patch openTab without overriding)
    var originalOpenTab = window.openTab;
    window.openTab = function(tabId){
      if(typeof originalOpenTab === 'function') originalOpenTab(tabId);
      // slight delay to allow table render
      setTimeout(function(){ filterVisibleTable(input.value); }, 0);
    };
  }
})();
</script></body>
</html>